<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

    <style>
        .panel * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .panel {
            border: 1px solid blue;
            width: 100%;
            height: 650px;
            position: relative;
        }

        /* 水平  */
        .horizontal-panel-wrapper {
            width: 100%;
            border: 1px solid red;
            padding-left: 40px;
            position: absolute;
            top: 0;
            display: flex;
        }
        .horizontal-panel-wrapper .item {
            width: 240px;
            height: 40px;
            line-height: 40px;
            padding: 0 30px;
            border-right: 1px solid black;
        }
        .horizontal-panel-wrapper .item:hover {
            resize: horizontal;
        }

        .horizontal-panel-wrapper > .item-wrapper {
            display: flex;
        }

        .panel .item {
            position: relative;
            display: flex;
            justify-content: center;
            overflow: auto;
        }
        .panel .item > span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: default;
        }

        /* 垂直 */
        .vertical-panel-wrapper {
            border: 1px solid red;
            position: absolute;
        }
        .vertical-panel-wrapper .item {
            height: 200px;
            border-bottom: 1px solid black;
            padding: 30px 0;
            width: 40px;
            writing-mode: vertical-lr;
            display: flex;
            align-items: center;
        }
        .vertical-panel-wrapper .item:hover {
            resize: vertical;
        }

        /* 新增 */
        .item-icon-add svg {
            fill: black;
            position: absolute;
            top: 50%;
            left: 50%;
            -webkit-transform: translate(-50%, -50%);
            -moz-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            -o-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }
        .item-icon-add {
            display: none;
            width: 30px;
            position: absolute;
            z-index: 9;
        }
        .item-icon-add:hover {
            cursor: pointer;
        }
        .item-icon-add svg {
            fill: grey;
        }
        .item-icon-add:hover svg {
            fill: black;
        }
        .horizontal-panel-wrapper > .item-icon-add {
            height: 40px;
            line-height: 40px;
            padding: 0 10px;
        }
        .vertical-panel-wrapper > .item-icon-add {
            height: 30px;
            width: 40px;
            text-align: center;
            padding: 6px 0;
        }
        .horizontal-panel-wrapper:hover .item-icon-add,
        .vertical-panel-wrapper:hover .item-icon-add {
            display: block;
        }

        /* 删除图标*/
        .item-icon-delete {
            display: none;
        }
        .item-icon-delete:hover {
            cursor: pointer;
        }
        .item:hover .item-icon-delete {
            display: block;
        }
        .item-icon-delete svg {
            fill: lightcoral;
            position: absolute;
        }
        .horizontal-panel-wrapper .item-icon-delete svg {
            right: 4px;
            top: 50%;
            -webkit-transform: translate(0, -50%);
            -moz-transform: translate(0, -50%);
            -ms-transform: translate(0, -50%);
            -o-transform: translate(0, -50%);
            transform: translate(0, -50%);
        }
        .vertical-panel-wrapper .item-icon-delete svg {
            bottom: 4px;
            left: 50%;
            -webkit-transform: translate(-50%, 0);
            -moz-transform: translate(-50%, 0);
            -ms-transform: translate(-50%, 0);
            -o-transform: translate(-50%, 0);
            transform: translate(-50%, 0);
        }
        .toggle-panel {
            width: 40px;
            height: 40px;
        }
        .toggle-panel:hover {
            background: grey;
        }

    </style>

</head>
<body>

<div name="flow-panel" class="panel"></div>

<script>

    class Lane {
        constructor(root) {
            this.init(root)
            this.bindFeature()
        }

        bindFeature() {
            this.togglePanel()
            this.removeField()
            this.editable()
            this.drag()
            this.dragItem()
            this.addDefaultField("x")
            this.addDefaultField("y")
        }

        init(root) {
            this.initXY("x", root)
            this.initXY("y", root)
        }

        initXY(xy, root) {
            if (xy !== "x" && xy !== "y") throw new Error("参数只能是x或y")
            let vh = xy === "y" ? "vertical" : "horizontal"
            let panelWrapper =
                $(`
                    <div class="${vh}-panel-wrapper">
                     ${xy === "y" ? "<div class='toggle-panel'></div>" : ""}
                     <i class="item-icon-add">
                        <svg t="1648538855144" class="icon" viewBox="0 0 1024 1024" version="1.1"
                               xmlns="http://www.w3.org/2000/svg" p-id="5243" width="20" height="20">
                              <path d="M512 149.333333c200.298667 0 362.666667 162.368 362.666667 362.666667s-162.368 362.666667-362.666667 362.666667S149.333333 712.298667 149.333333 512 311.701333 149.333333 512
                                149.333333z m0 64c-164.949333 0-298.666667 133.717333-298.666667 298.666667s133.717333 298.666667 298.666667 298.666667 298.666667-133.717333 298.666667-298.666667-133.717333-298.666667-298.666667-298.666667z m32
                                106.666667v160H704v64h-160V704h-64v-160.021333L320 544v-64l160-0.021333V320h64z"
                                p-id="5244">
                              </path>
                         </svg>
                     </i>
                     <div class="item-wrapper"></div>
                    </div>
                `)
            root.append(panelWrapper)
        }

        editable() {
            $(".panel").on("dblclick", "span", function (e) {
                e.stopPropagation()
                let self = $(this)
                let currentVal = $(this).text()
                self.attr("contenteditable", "true")
                self.css({
                    background: "#f1eded",
                    outline: "1px solid grey"
                })
                $(this).parents()[2].className.substring(0, 1) === "h"
                    ? self.css({padding: "0 12px",})
                    : self.css({padding: "12px 0", width: "100%"})
                self.focus()
                let sel = window.getSelection()
                sel.collapse(self[0], 1)
                $(document).click(function () {
                    self.removeAttr("contenteditable")
                    self.css({
                        padding: "", width: "",
                        background: "", outline: ""
                    })
                    self.text() === '' ? self.text(currentVal) : ""
                })
            })
        }

        drag() {
            $(".item-wrapper")
                .on("drop", function (ev) {
                    ev.preventDefault();
                    let data = ev.originalEvent.dataTransfer.getData("text/plain");
                    let thisDiv = ev.target;
                    $(document.getElementById(data)).insertBefore(thisDiv);
                })
                .on("dragover", function (ev) {
                    ev.originalEvent.preventDefault();
                })
            this.dragItem()
        }

        dragItem() {
            $(".item").on("dragstart", function (ev) {
                ev.originalEvent.dataTransfer.setData("text/plain", ev.target.id);
            })
        }

        addDefaultField(xy, data) {
            if (xy !== "x" && xy !== "y") throw new Error("参数只能是x或y")
            let that = this
            let vh = xy === "y" ? "vertical" : "horizontal"
            $("." + vh + "-panel-wrapper>.item-icon-add")
                .on("click", function () {
                    that.itemContent(xy, data).appendTo($(this).next())
                    that.removeField()
                    that.dragItem()
                })
        }

        removeField() {
            $(".item-icon-delete").on("click", function () {
                $(this).parent().parent().children().length > 1
                    ? $(this).parent().remove() : ""
            })
        }

        togglePanel() {
            $(".toggle-panel").on("dblclick", function () {
                let xSelector = $(".horizontal-panel-wrapper>.item-wrapper .item");
                let ySelector = $(".vertical-panel-wrapper>.item-wrapper .item");
                for (let i = 0; i < xSelector.length; i++) {
                    let x = xSelector[i].innerText;
                    let y = ySelector[i].innerText;
                    [x, y] = [y, x];
                    xSelector.children("span")[i].innerHTML = x
                    ySelector.children("span")[i].innerHTML = y
                }
            })
        }

        itemContent(xy, ts) {
            let title = ts?.title
            let size = ts?.size
            return $(`<div id=${xy + "-" + Math.random().toString(36).slice(-4)}
                              draggable="true" class="item"
                              style="${xy === "y" ? "height" : "width"}:${size || ''}px">
                            <span>${title || "修改名称"}</span>
                            <i class="item-icon-delete">
                              <svg t="1648537726522" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                 xmlns="http://www.w3.org/2000/svg" p-id="3759" width="20" height="20">
                                 <path d="M512 0C230.4 0 0 230.4 0 512s230.4 512 512 512 512-230.4 512-512S793.6 0
                                 512 0z m0 938.666667C277.333333 938.666667 85.333333 746.666667 85.333333 512S277.333333
                                 85.333333 512 85.333333s426.666667 192 426.666667 426.666667-192 426.666667-426.666667 426.666667z"
                                 p-id="3760"></path>
                                 <path d="M341.333333 469.333333h341.333334v85.333334H341.333333z" p-id="3761"></path>
                                 </svg>
                            </i>
                       </div>`)
        }

        add(xy, data) {
            if (!xy || !data) throw new Error("需要传入xy和data")
            if (xy !== "x" && xy !== "y") throw new Error("参数只能是x或y")
            if (!data.title) throw new Error("data需要title")
            let a = xy === "x" ? "horizontal" : "vertical"
            $("." + a + "-panel-wrapper>.item-wrapper")
                .append(this.itemContent(xy, data))
            this.removeField()
            this.dragItem()
        }

        #data = {vert: [], horz: [],}

        getData(xy) {
            let xTitles, yTitles
            for (let key in this.#data) {
                if (key === "vert") yTitles = this.#data[key]
                else xTitles = this.#data[key]
            }
            return xy === "x" ? xTitles : yTitles
        }

        setData(data) {
            this.#data = data
            this.addMultiple(this.#data)
        }

        addMultiple(data) {
            let xTitles, yTitles
            for (let key in data) {
                if (key === "vert") yTitles = data[key]
                else xTitles = data[key]
            }
            for (let i = 0; i < xTitles.length; i++) {
                let title = xTitles[i]
                this.add("x", {title})
            }
            for (let i = 0; i < yTitles.length; i++) {
                let title = yTitles[i]
                this.add("y", {title})
            }
        }
    }

    let v = new Lane($(".panel"))

    v.setData({
        vert: ["起草", "审批", "处理","事物"],
        horz: ["业务部", "人事部", "财务部","法律部"],
    })
    console.log(v.getData("x"))
    console.log(v.getData("y"))

    // v.add("x", {title: "业务部1"})
    // v.add("x", {title: "财务部2", size: 130})
    // v.add("x", {title: "人事部3"})
    //
    // v.add("y", {title: "起草1", size: 200})
    // v.add("y", {title: "审批2", size: 200})
    // v.add("y", {title: "处理3", size: 200})

</script>


</body>

</html>
