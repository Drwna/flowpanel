<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <title>flowPanel4</title>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.8.2/jquery.min.js"></script>

    <style>
        .panel * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .panel {
            border: 1px solid blue;
            width: 100%;
            height: 650px;
            position: relative;
        }

        /* 水平  */
        .horizontal-panel-wrapper {
            height: 42px;
            width: 100%;
            border: 1px solid red;
            padding-left: 40px;
            position: absolute;
            top: 0;
            display: flex;
        }
        .horizontal-panel-wrapper .item {
            width: 240px;
            height: 40px;
            line-height: 40px;
            padding: 0 30px;
            border-right: 1px solid black;
        }
        .horizontal-panel-wrapper .item:hover {
            resize: horizontal;
        }
        .horizontal-panel-wrapper > .item-wrapper {
            display: flex;
        }
        .panel .item {
            /*position: relative;*/
            display: flex;
            justify-content: center;
            overflow: auto;
        }
        .panel .item > span {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: default;
        }

        /* 垂直 */
        .vertical-panel-wrapper {
            height: 640px;
            width: 42px;
            border: 1px solid red;
            position: absolute;
        }
        .vertical-panel-wrapper .item {
            height: 200px;
            border-bottom: 1px solid black;
            padding: 30px 0;
            width: 40px;
            -webkit-writing-mode: vertical-rl;
            writing-mode: vertical-lr;
            overflow: hidden;
            display: flex;
            align-items: center;
        }
        .vertical-panel-wrapper .item:hover {
            resize: vertical;
        }

        /* 新增 */
        .item-icon-add svg {
            fill: black;
            position: absolute;
            top: 50%;
            left: 50%;
            -webkit-transform: translate(-50%, -50%);
            -moz-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            -o-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }
        .item-icon-add {
            display: none;
            width: 30px;
            position: absolute;
            z-index: 9;
        }
        .item-icon-add:hover {
            cursor: pointer;
        }
        .item-icon-add svg {
            fill: grey;
        }
        .item-icon-add:hover svg {
            fill: black;
        }
        .horizontal-panel-wrapper > .item-icon-add {
            height: 40px;
            line-height: 40px;
            padding: 0 10px;
        }
        .vertical-panel-wrapper > .item-icon-add {
            /*margin-top: 40px;*/
            height: 30px;
            width: 40px;
            text-align: center;
            padding: 6px 0;
        }
        .horizontal-panel-wrapper:hover .item-icon-add {
            display: block;
        }

        /* 删除图标*/
        .item-icon-delete {
            display: none;
        }
        .item-icon-delete:hover {
            cursor: pointer;
        }
        .item-icon-delete:hover svg {
            fill: red;
        }
        .item:hover .item-icon-delete {
            display: block;
        }
        .item-icon-delete svg {
            fill: lightcoral;
            position: absolute;
        }
        .horizontal-panel-wrapper .item-icon-delete svg {
            right: 0.5em;
            top: 50%;
            -webkit-transform: translate(0, -50%);
            -moz-transform: translate(0, -50%);
            -ms-transform: translate(0, -50%);
            -o-transform: translate(0, -50%);
            transform: translate(0, -50%);
        }
        .vertical-panel-wrapper .item-icon-delete svg {
            bottom: 0.5em;
            left: 50%;
            -webkit-transform: translate(-50%, 0);
            -moz-transform: translate(-50%, 0);
            -ms-transform: translate(-50%, 0);
            -o-transform: translate(-50%, 0);
            transform: translate(-50%, 0);
        }
        .toggle-panel {
            width: 40px;
            height: 40px;
        }
        .toggle-panel:hover {
            background: grey;
        }

        body {
            background-color: gainsboro;
        }
    </style>

    <style>
        * {
            margin: 0;
            padding: 0;
        }
        #box {
            width: 602px;
            height: 82px;
            border: 1px solid #000;
            background-color: slategray;
            margin: 20px 0 10px 20px;
            display: flex;
        }
        #box .itemDiv {
            height: 80px;
            width: 80px;
            line-height: 80px;
            text-align: center;
            border: 1px solid skyblue;
            background-color: #fff;
        }
        #box .drag {
            position: absolute;
            width: 80px;
            height: 80px;
            line-height: 80px;
            text-align: center;
            border: 1px solid #00ff;
        }
        .zw {
            /* float: left; */
            display: flex;
            width: 80px;
            height: 80px;
            border: 1px dashed #f00;
        }
    </style>

    <style>
        .dragItem {
            position: absolute;
            width: 140px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            border: 1px solid #00ff;
            background: rosybrown;
        }
        .zwItem {
            display: flex;
            width: 140px;
            height: 40px;
            border: 1px dashed #f00;
        }
    </style>

</head>
<body>
<div class="panel"></div>
<div id="box"></div>
<div id="add"
     style=" width: 90px; height: 60px; line-height: 60px;
        text-align: center; background-color: tomato;
        position: fixed; right: 80px; bottom: 50px; ">
    添加
</div>


<script>
    class Lane {
        #data = {vert: [], horz: []};

        constructor(root) {
            this.root = root;
            this.#init();
        }

        #init() {
            Lane.#initXY("x", this.root);
            Lane.#initXY("y", this.root);
            this.#handleCSS();
            this.#addDefaultField("x", {title: "xxx"});
            this.#addDefaultField("y", {title: "yyy"});
            this.#editable();
            this.#togglePanel();
            // this.#drag()
        }

        static #initXY(xy, root) {
            let panelWrapper = $(`
                    <div class="${
                xy === "y" ? "vertical" : "horizontal"
            }-panel-wrapper">
                     ${
                xy === "y"
                    ? "<div class='toggle-panel'><div class='tc'></div></div>"
                    : ""
            }
                         <i class="item-icon-add">
                            <svg t="1648779147774" class="icon" viewBox="0 0 1024 1024" version="1.1"
                            xmlns="http://www.w3.org/2000/svg" p-id="1633" width="20" height="20">
                            <path d="M512 1024C229.229714 1024 0 794.770286 0 512S229.229714 0 512 0s512
                            229.229714 512 512-229.229714 512-512 512z m0-928C282.258286 96 96 282.258286 96
                            512S282.258286 928 512 928 928 741.741714 928 512 741.741714 96 512 96z m208.018286
                            463.981714h-160v160.036572a48.018286 48.018286 0 0 1-96.036572 0v-160.036572H303.981714a47.981714
                            47.981714 0 0 1 0-95.963428h160V304.018286a48.018286 48.018286 0 0 1 96.036572 0v160h160a47.981714
                             47.981714 0 0 1 0 95.963428z" fill="" p-id="1634"></path>
                             </svg>
                         </i>
                     <div id="item-p" class="item-wrapper"></div>
                    </div>
                `);
            root.append(panelWrapper);
        }

        #handleCSS() {
            $(".vertical-panel-wrapper>.item-wrapper")
                .mouseenter(function () {
                    $(this)
                        .parent()
                        .children(".item-icon-add")
                        .css({display: "block"});
                })
                .mouseleave(function () {
                    $(this)
                        .parent()
                        .children(".item-icon-add")
                        .css({display: "none"});
                })
                .children().length === 0 &&
            $(".vertical-panel-wrapper>.item-wrapper").css({height: "100%"});
            $(".vertical-panel-wrapper>.item-icon-add")
                .mouseenter(function () {
                    $(this).css({display: "block"});
                })
                .mouseleave(function () {
                    $(this).css({display: "none"});
                });
        }

        static #handleData(data) {
            let xTitles, yTitles;
            for (let key in data) {
                key === "vert" ? (yTitles = data[key]) : (xTitles = data[key]);
            }
            return {xTitles, yTitles};
        }

        static #itemContent(xy, ts) {
            return $(`<div id=${xy + "-" + Math.random().toString(36).slice(-4)}
                               class="item"
                              style="${xy === "y" ? "height" : "width"}:${
                ts.size || ""
            }px">
                            <span>${ts.title}</span>
                            <i class="item-icon-delete">
                                <svg t="1648779026180" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                    xmlns="http://www.w3.org/2000/svg" p-id="1483" width="20" height="20">
                                    <path d="M512 1024C229.229714 1024 0 794.770286 0 512S229.229714 0 512 0s512
                                    229.229714 512 512-229.229714 512-512 512z m0-928C282.258286 96 96 282.258286
                                    96 512S282.258286 928 512 928 928 741.741714 928 512 741.741714 96 512 96z m207.981714
                                    463.981714H304.018286a47.981714 47.981714 0 1 1 0-95.963428h415.963428a47.981714 47.981714 0 1 1 0 95.963428z"
                                    fill="" p-id="1484"></path>
                                </svg>
                            </i>
                       </div>`);
        }

        getData(xy) {
            return xy
                ? xy === "x"
                    ? Lane.#handleData(this.#data).xTitles
                    : Lane.#handleData(this.#data).yTitles
                : this.#data;
        }

        add(xy, data, able = true) {
            if (!xy || !data) throw new Error("需要传入xy和data");
            if (xy !== "x" && xy !== "y") throw new Error("参数只能是x或y");
            if (!data.title || data.title.match(/^[ ]*$/))
                throw new Error("data需要title");
            able && xy === "x"
                ? this.#data.horz.push(data?.title)
                : this.#data.vert.push(data?.title);
            $(
                "." +
                `${xy === "x" ? "horizontal" : "vertical"}` +
                "-panel-wrapper>.item-wrapper"
            ).append(Lane.#itemContent(xy, data));
            this.#removeField();
            this.#dragItem();
        }

        #addDefaultField(xy, data) {
            let self = this;
            $(
                "." +
                `${xy === "y" ? "vertical" : "horizontal"}` +
                "-panel-wrapper>.item-icon-add"
            ).on("click", function () {
                self.add(xy, data);
                self.#removeField();
            });
        }

        arrayIndex(array, value) {
            for (let i = 0; i < array.length; i++) {
                if (array[i] === value) return i;
            }
            return -1;
        }

        removeArray(arr, val) {
            this.arrayIndex(arr, val) > -1 &&
            arr.splice(this.arrayIndex(arr, val), 1);
        }

        #delete(xy, el) {
            let {xTitles, yTitles} = Lane.#handleData(this.#data);
            xy === "x"
                ? this.removeArray(xTitles, el[0].innerText)
                : this.removeArray(yTitles, el[0].innerText);
            el.remove();
        }

        #removeField() {
            let self = this;
            $(".panel .item-icon-delete")
                .off("click")
                .on("click", function () {
                    $(this).parents(".item-wrapper").children().length === 1 &&
                    $(".vertical-panel-wrapper")
                        .children(".item-wrapper")
                        .css({height: "calc(100% - 40px)", width: "42px"})
                        .parent()
                        .children(".item-icon-add")
                        .css({display: "none"});
                    let xy = $(this)
                        .parents(".item-wrapper")
                        .parent()[0]
                        .className.substr(0, 1);
                    self.#delete(xy, $(this).parent());
                });
        }

        #editable() {
            let that = this;
            let {xTitles, yTitles} = Lane.#handleData(this.#data);
            this.root.on("dblclick", "span", function () {
                let self = $(this);
                let currentVal = self.text();
                let xy = self
                    .parents(".item-wrapper")
                    .parent()[0]
                    .className.substr(0, 1);
                let currentIndex = that.arrayIndex(
                    xy === "h" ? xTitles : yTitles,
                    currentVal
                );
                $(this).attr("contenteditable", "true");
                self.css({background: "#f1eded", outline: "1px solid grey"});
                $(this).parents()[2].className.substr(0, 1) === "h"
                    ? self.css({padding: "0 12px"})
                    : self.css({padding: "12px 0", width: "100%"});
                $(this).focus();
                let sel = window.getSelection();
                sel.collapse(self[0], 1);
                $(this).on("blur", function () {
                    self.removeAttr("contenteditable");
                    self.css({background: "", outline: "", padding: "", width: ""});
                    self.text().trim() === "" && self.text(currentVal);
                    if (xy === "h") xTitles[currentIndex] = self.text();
                    else yTitles[currentIndex] = self.text();
                });
            });
        }

        #togglePanel() {
            let self = this;
            $(".toggle-panel").on("dblclick", function () {
                let x = $(".horizontal-panel-wrapper>.item-wrapper").children(
                    ".item"
                );
                let y = $(".vertical-panel-wrapper>.item-wrapper").children(
                    ".item"
                );
                let xLength = x.length;
                let yLength = y.length;
                if (xLength === yLength) {
                    for (let i = 0; i < xLength; i++) {
                        let xSize = x[i].offsetWidth;
                        let xTitle = x[i].innerText;
                        self.#delete("x", $(x[i]));
                        self.add("y", {title: xTitle, size: xSize});
                        let ySize = y[i].offsetHeight;
                        let yTitle = y[i].innerText;
                        self.#delete("y", $(y[i]));
                        self.add("x", {title: yTitle, size: ySize});
                    }
                } else {
                    if (xLength > yLength) {
                        for (let i = 0; i < xLength; i++) {
                            let xSize = x[i].offsetWidth;
                            let xTitle = x[i].innerText;
                            self.#delete("x", $(x[i]));
                            self.add("y", {title: xTitle, size: xSize});
                            try {
                                let ySize = y[i].offsetHeight;
                                let yTitle = y[i].innerText;
                                self.#delete("y", $(y[i]));
                                self.add("x", {title: yTitle, size: ySize});
                            } catch (e) {
                            }
                        }
                    } else {
                        for (let i = 0; i < yLength; i++) {
                            let ySize = y[i].offsetHeight;
                            let yTitle = y[i].innerText;
                            self.#delete("y", $(y[i]));
                            self.add("x", {title: yTitle, size: ySize});
                            try {
                                let xSize = x[i].offsetWidth;
                                let xTitle = x[i].innerText;
                                self.#delete("x", $(x[i]));
                                self.add("y", {title: xTitle, size: xSize});
                            } catch (e) {
                            }
                        }
                    }
                }
                console.log("切换后：", self.getData());
            });
        }

        #drag() {
            $(".item-wrapper")
                .on("drop", function (ev) {
                    ev.preventDefault();
                    let data = ev.originalEvent.dataTransfer.getData(
                        "application/x-moz-node"
                    );
                    let thisDiv = ev.target;
                    $(document.getElementById(data)).insertBefore(thisDiv);
                })
                .on("dragover", function (ev) {
                    ev.originalEvent.preventDefault();
                });
            this.#dragItem();
        }

        #dragItem() {
            let self = this;
            $(".item")
                .off("dragstart")
                .on("dragstart", function (ev) {
                    ev.originalEvent.dataTransfer.setData(
                        "application/x-moz-node",
                        ev.target.id
                    );
                    $(this).css({background: "rgba(0,0,0,0.2)"});
                })
                .off("dragend")
                .on("dragend", function () {
                    $(this).css({background: ""});
                    let xy =
                        $(this).parent().parent()[0].className.substr(0, 1) === "h"
                            ? "x"
                            : "y";
                    self.#updateData(xy);
                });
        }

        #updateData(xy) {
            if (xy === "x") {
                let length = $(".horizontal-panel-wrapper>.item-wrapper").children()
                    .length;
                for (let i = 0; i < length; i++) {
                    let x = $(".horizontal-panel-wrapper>.item-wrapper>.item");
                    let title = x[i].innerText;
                    let size = x[i].offsetWidth;
                    this.#delete("x", $(x[i]));
                    this.add("x", {title, size});
                }
            } else {
                let length = $(".vertical-panel-wrapper>.item-wrapper").children()
                    .length;
                for (let i = 0; i < length; i++) {
                    let y = $(".vertical-panel-wrapper>.item-wrapper>.item");
                    let title = y[i].innerText;
                    let size = y[i].offsetHeight;
                    this.#delete("y", $(y[i]));
                    this.add("y", {title, size});
                }
            }
        }
    }

    let v = new Lane($(".panel"));

    v.add("x", {title: "1-业务部", size: 140});
    v.add("x", {title: "2-人事部", size: 140});
    v.add("x", {title: "3-行政部", size: 140});
    // v.add("x", {title: "4-测试部", size: 140})
    // v.add("x", {title: "5-后勤部", size: 140})

    // v.add("y", {title: "1-起草", size: 120});
    // v.add("y", {title: "2-审批", size: 120});
    // v.add("y", {title: "3-处理", size: 120});
    // v.add("y", {title: "4-test", size: 120});
    // console.log(v.getData())
    // console.log(v.getData("x"))
    // console.log(v.getData("y"))
</script>


<script>
    // 添加div
    $(function () {
        $("#add").on("click", function () {
            let len = $("#box").children().length;
            let bgColor = Tool.randomColor2();
            let divHtml = `
            <div class="itemDiv" style="background-color:${bgColor}">
                ${len + 1}
            </div>`;
            $(divHtml).appendTo("#box");
        });
        Tool.drags("box", "itemDiv", "drag", "zw");
    })
</script>

<script>
    class Tool {
        /******************************************************
         * div拖拽排序：
         * ******************************************
         * 支持上 下 左 右四个方向拖拽
         * box：要拖拽元素父元素的id值
         * name：要拖拽元素未拖拽时的样式的class名
         * name2：要拖拽元素拖拽时样式的class名
         * name3：拖拽时占位使用的样式的class名
         *
         *****************************************************/
        static drags(box, name, name2, name3) {
            let range = {x: 0, y: 0}; // 鼠标元素偏移量
            let lastPos = {x: 0, y: 0, x1: 0, y1: 0}; // 拖拽对象的四个坐标
            let tarPos = {x: 0, y: 0, x1: 0, y1: 0}; // 目标元素对象的坐标初始化
            let thisDiv = null, move = false, choose = false; // 拖拽对象 拖拽状态 选中状态
            //拖拽对象的索引、高度、的初始化。
            let thisDivWidth = 0, thisDivHeight = 0,
                thisDivHalfW = 0, thisDivHalfH = 0,
                tarFirstX = 0, tarFirstY = 0;
            let tarDiv = null, tarFirst, tempDiv; // 要插入的目标元素的对象, 临时的虚线对象
            let initPos = {x: 0, y: 0};  // 记录拖拽元素初始鼠标元素偏移量

            //鼠标按下时执行的事件（为防止动态添加元素无法使用，在这里使用事件委托的格式）
            $(`#${box}`).on('mousedown', `.${name}`, function (event) {

                choose = true;
                // 拖拽对象
                thisDiv = $(this);
                // 记录拖拽元素初始位置
                initPos.x = thisDiv.offset().left;
                initPos.y = thisDiv.offset().top;
                // 鼠标元素相对偏移量
                console.log(event.pageX, event.pageY);
                range.x = event.pageX - thisDiv.offset().left;
                range.y = event.pageY - thisDiv.offset().top;

                thisDivWidth = thisDiv.width();
                thisDivHeight = thisDiv.height();
                thisDivHalfW = thisDivWidth / 2;
                thisDivHalfH = thisDivHeight / 2;
                thisDiv.attr("class", name2);
                thisDiv.css({left: initPos.x + 'px', top: initPos.y + 'px'});

                // 创建新元素 插入拖拽元素之前的位置(虚线框)
                $("<div class='" + name3 + "'></div>").insertBefore(thisDiv);
                tempDiv = $("." + name3);

            });

            $(document).on('mouseup', function (event) {

                if (!choose) {
                    return false;
                }

                if (!move) {
                    thisDiv.attr("class", name);
                    tempDiv.remove(); // 删除新建的虚线div
                    choose = false;
                    return false;
                }

                thisDiv.insertBefore(tempDiv); // 拖拽元素插入到 虚线div的位置上
                thisDiv.attr("class", name); //恢复对象的初始样式
                tempDiv.remove(); // 删除新建的虚线div
                move = false;
                choose = false;

            }).on('mousemove', function (event) {

                if (!choose) return false;

                move = true;
                lastPos.x = event.pageX - range.x;
                lastPos.y = event.pageY - range.y;
                lastPos.x1 = lastPos.x + thisDivWidth;
                lastPos.y1 = lastPos.y + thisDivHeight;
                // 拖拽元素随鼠标移动
                // thisDiv.css({left: lastPos.x + 'px', top: lastPos.y + 'px'});
                thisDiv.css({left: lastPos.x + 'px'});
                // 拖拽元素随鼠标移动 查找插入目标元素
                let $main = $('.' + name); // 局部变量：按照重新排列过的顺序 再次获取 各个元素的坐标，

                $main.each(function () {

                    tarDiv = $(this);
                    console.log(tarDiv.offset())
                    tarPos.x = tarDiv.offset().left;
                    tarPos.y = tarDiv.offset().top;
                    tarPos.x1 = tarPos.x + tarDiv.width() / 2;
                    tarPos.y1 = tarPos.y + tarDiv.height() / 2;
                    tarFirst = $main.eq(0); // 获得第一个元素
                    tarFirstX = tarFirst.offset().left + thisDivHalfW / 2; // 第一个元素对象的中心纵坐标
                    tarFirstY = tarFirst.offset().top + thisDivHalfH / 2; // 第一个元素对象的中心横坐标

                    // 根据 拖拽对象x坐标 与 目标元素对象x坐标 对比，来显示 虚线div 在节点前、后出现的位置
                    if (lastPos.x > tarPos.x) {
                        //拖拽对象 移动到第一个位置
                        if (lastPos.x <= tarFirstX && lastPos.y <= tarFirstY) {
                            tempDiv.insertBefore(tarFirst);
                        }
                        // 判断要插入目标元素的 坐标后， 直接插入
                        if (lastPos.x <= tarPos.x + thisDivHalfW && lastPos.x1 >= tarPos.x1 && lastPos.y <= tarPos.y + thisDivHalfH && lastPos.y1 >= tarPos.y1) {
                            tempDiv.insertAfter(tarDiv);
                        }
                    } else {
                        //拖拽对象 移动到第一个位置
                        if (lastPos.x <= tarFirstX && lastPos.y <= tarFirstY) {
                            tempDiv.insertBefore(tarFirst);
                        }
                        // 判断要插入目标元素的 坐标后， 直接插入
                        if (lastPos.x >= tarPos.x - thisDivHalfW && lastPos.x1 >= tarPos.x1 && lastPos.y >= tarPos.y - thisDivHalfH && lastPos.y1 >= tarPos.y1) {
                            tempDiv.insertAfter(tarDiv);
                        }
                    }
                });
            });
        }


        /*******************************************************************
         *生成随机颜色
         *********************************************
         * randomColor1():返回10进制颜色值，例如：#167772
         * randomColor2():返回16进制颜色值，例如：#ffffff
         * randomColor3():返回rgb格式颜色值，例如：rgb(255,255,255)
         *
         *********************************************************************/
        static randomColor1() {
            return '#' + Math.floor(Math.random() * 256).toString(10);
        }

        static randomColor2() {
            return '#' + Math.floor(Math.random() * 0xffffff).toString(16);
        }

        static randomColor3() {
            let r = Math.floor(Math.random() * 256);
            let g = Math.floor(Math.random() * 256);
            let b = Math.floor(Math.random() * 256);
            return "rgb(" + r + ',' + g + ',' + b + ")";//所有方法的拼接都可以用ES6新特性`其他字符串{$变量名}`替换
        }
    }
</script>

<script>
    Tool.drags("item-p", "item", "dragItem", "zwItem");
</script>


</body>
</html>
