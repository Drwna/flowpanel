<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
          integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <title>float demo</title>
    <style>
        :root {
            --panel-size: 40px;
        }
        .panel > * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .panel {
            border: 1px solid rgb(80, 77, 77);
            /*padding: 8px;*/
            width: 1200px;
            height: 600px;
        }
        .panel .item-wrapper {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .panel .item > span {
            background-color: yellowgreen;
            cursor: default;
        }
        .panel .icon-add, .panel .icon-delete {
            cursor: default;
        }

        .toggle {
            width: var(--panel-size);
            height: var(--panel-size);
            line-height: var(--panel-size);
            text-align: center;
            border: 1px solid black;
            float: left;
            color: grey;
        }
        .toggle:hover {
            color: black;
        }

        .horz {
            width: 1000px;
            height: var(--panel-size);
            border-top: 1px solid black;
            border-right: 1px solid black;
            border-bottom: 1px solid black;
            display: flex;
            position: relative;
        }
        .horz > .icon-add {
            position: absolute;
            top: 50%; left: 0;
            transform: translateY(-50%);
            width: 21px;
            padding-left: 6px;
            display: none;
        }
        .horz:hover > .icon-add {
            display: block;
            color: grey;
        }
        .horz > .icon-add:hover {
            color: black;
            cursor: pointer;
        }
        .horz > .item-wrapper {
            height: 100%;
            display: flex;
        }
        .horz .item {
            width: 200px;
            height: 100%;
            position: relative;
            display: flex;
            border-right: 1px solid black;
        }
        .horz .item span {
            width: 100%; height: 100%;
            padding: 0 27px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
            line-height: var(--panel-size);
        }
        .horz:hover .item {
            overflow: hidden;
            resize: horizontal;
        }
        .horz .icon-delete {
            position: absolute;
            top: 50%; right: 0;
            transform: translateY(-50%);
            width: 21px;
            height: var(--panel-size);
            line-height: var(--panel-size);
            padding-right: 6px;
            display: none;
            color: grey;
        }

        .horz .item:hover .icon-delete {
            display: block;
        }
        .horz .item:hover .icon-delete:hover {
            color: black;
            cursor: pointer;
        }

        .vert {
            height: 500px;
            width: var(--panel-size);
            border-left: 1px solid black;
            border-right: 1px solid black;
            border-bottom: 1px solid black;
            display: flex;
            position: relative;
        }
        .vert > .icon-add {
            position: absolute;
            top: 0; left: 50%;
            transform: translateX(-50%);
            height: 21px;
            padding-top: 6px;
            color: grey;
            display: none;
        }
        .vert:hover > .icon-add {
            display: block;
        }
        .vert > .icon-add:hover {
            color: black;
            cursor: pointer;
        }
        .vert > .item-wrapper {
            width: 100%;
        }
        .vert .item {
            width: 100%;
            height: 140px;
            -webkit-writing-mode: vertical-rl;
            writing-mode: vertical-lr;
            display: flex;
            text-align: center;
            position: relative;
            border-bottom: 1px solid black;
        }
        .vert:hover .item {
            overflow: hidden;
            resize: vertical;
        }
        .vert .item span {
            height: 100%; width: 100%;
            padding: 27px 0;
            line-height: var(--panel-size);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .vert .icon-delete {
            position: absolute;
            bottom: 0; left: 50%;
            transform: translateX(-50%);
            height: 21px;
            padding-bottom: 6px;
            display: none;
            width: var(--panel-size);
            line-height: var(--panel-size);
        }
        .vert .item:hover .icon-delete {
            display: block;
            color: grey;
        }
        .vert .item:hover .icon-delete:hover {
            color: black;
            cursor: pointer;
        }

        .horz input {
            text-align: center;
            height: 80%; width: 90%;
            font-size: inherit;
            outline-style: none;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
        }
        .horz input:focus {
            border-color: #66afe9;
            outline: 0;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075),
            0 0 8px rgba(102, 175, 233, 0.6);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            z-index: 9999;
        }
        .overlay input {
            position: fixed;
            width: 200px;
            height: 34px;
            text-align: center;
            font-size: inherit;
            outline-style: none;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
        }
        .overlay input:focus {
            border-color: #66afe9;
            outline: 0;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075),
            0 0 8px rgba(102, 175, 233, 0.6);
        }

        .hDragItem {
            position: absolute;
            height: 100%;
            line-height: var(--panel-size);
            text-align: center;
            background-color: grey;
            color: white;
            border-radius: 5px;
            box-shadow: 0 0 5px #ccc;
            z-index: 4;
        }
        .hDragItem span {
            padding: 0 20px;
        }

        .hPlaceholder {
            outline: 1px dashed black;
            height: 100%;
            background-color: lightblue;
        }

        .vDragItem {
            position: absolute;
            width: 100%;
            line-height: var(--panel-size);
            text-align: center;
            white-space: nowrap;
            background-color: grey;
            color: white;
            border-radius: 5px;
            box-shadow: 0 0 5px #ccc;
            z-index: 4;
            -webkit-writing-mode: vertical-rl;
            writing-mode: vertical-lr;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .vDragItem span {
            padding: 20px 0;
        }
        .vPlaceholder {
            outline: 1px dashed black;
            background-color: lightblue;
        }
    </style>
</head>
<body>
<div class="panel"></div>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="jstx/src/jst-core.js"></script>
<script>

    class Panel {

        #data = {
            horz: [],
            vert: [],
            horz_size: [],
            vert_size: [],
        };

        #template = $(`
            <div class="panel-wrapper">
                <i class="toggle fa fa-refresh fa-lg"></i>
                <div class="horz">
                    <div ids="hItems" class="item-wrapper">
                        <div jst-for="let i=0; i<horz.length; i++" class="item hItem"
                             style="width: {{horz_size[i]}}px;">
                            <span jst-text="{{horz[i]}}"></span>
                            <i class="icon-delete fa fa-minus-circle fa-lg"></i>
                        </div>
                    </div>
                    <i class="icon-add fa fa-plus-circle fa-lg"></i>
                </div>
                <div class="vert">
                    <div ids="vItems" class="item-wrapper">
                        <div jst-for="let i=0; i<vert.length; i++" class="item vItem"
                             style="height: {{vert_size[i]}}px;">
                            <span jst-text="{{vert[i]}}"></span>
                            <i class="icon-delete fa fa-minus-circle fa-lg"></i>
                        </div>
                    </div>
                    <i class="icon-add fa fa-plus-circle fa-lg"></i>
                </div>
            </div>
        `);

        constructor(root) {
            this.root = root;
            this.#init(root, this.#template, this.#data);
        }

        #init(root, template, data) {
            template.appendTo(root);
            this.#render(data);
            this.#bindEvent();
        }

        #render(data) {
            new jst($(".panel-wrapper")[0]).render(data);
        }

        #bindEvent() {
            this.root.on({
                "dblclick": (e) => {
                    if (e.target.className.toLowerCase().includes("toggle")) {
                        // 双击切换
                        this.#toggle();
                    } else if (e.target.nodeName.toLowerCase().includes("span")) {
                        // 双击编辑
                        this.#edit($(e.target));
                    }
                },
                "mousedown": (e) => {
                    e.stopPropagation();
                    let target = $(e.target);
                    let targetName = e.target.className.toLowerCase();
                    let hv;
                    let cursorStyle = window.getComputedStyle(e.target).cursor;

                    if (targetName.includes("icon-add")) {
                        hv = target.parent().attr("class").substr(0, 1);
                        this.#addDefaultField(hv);

                    } else if (targetName.includes("icon-delete")) {
                        hv = target.parents(".item-wrapper").parent().attr("class").substr(0, 1);
                        target = target.parent();
                        this.#removeField(hv, target);

                    } else if (cursorStyle === "default" && targetName === "") {
                        target = target.parent();
                        let hv = target.parent().attr("ids").substr(0, 1);
                        this.#drag(e, target, hv, `${hv}Items`, `${hv}Item`, `${hv}DragItem`, `${hv}Placeholder`);

                    } else if (cursorStyle === "auto") {
                        this.#resize();
                    }
                }
            });
        }

        #addDefaultField(hv) {
            let title = "新增字段";
            hv === "h" ?
                this.#data.horz.push(title) && this.#data.horz_size.push(200)
                : this.#data.vert.push(title) && this.#data.vert_size.push(200);
            this.#render(this.#data);
        }

        #removeField(hv, target) {
            let index = target.index();
            hv === "h" ?
                this.#data.horz.splice(index, 1) && this.#data.horz_size.splice(index, 1)
                : this.#data.vert.splice(index, 1) && this.#data.vert_size.splice(index, 1);
            target.remove();
        }

        #edit(target) {
            // 还可优化
            let currentTag = target;
            let hv = currentTag.parents(".item-wrapper")
                .parent()[0].className.substr(0, 1);
            let oldText = target[0].innerText;
            let newText;
            let input = $(`<input type='text'/>`).val(oldText);

            let updateValue = (o) => {
                newText = input.val().trim() === "" ? oldText : input.val().trim();
                currentTag.html(newText);
                o?.remove();
                if (newText === oldText) return;
                let index = target.parent().index();
                hv === "h" ?
                    this.#data.horz[index] = newText :
                    this.#data.vert[index] = newText;
                console.log(this.#data);
            };

            if (hv === 'h') {
                currentTag.html(input);
                input.select().on({
                    "blur": () => updateValue(),
                    "keydown": (e) => {
                        e.keyCode === 13 && updateValue();
                    },
                });
                $(window).scroll(() => {
                    updateValue();
                    $(window).off("scroll");
                });
            } else {
                let overlayDiv = $(`<div class="overlay"></div>`);

                input.appendTo(overlayDiv);
                overlayDiv.appendTo($(document.body));

                let item = currentTag.parent();
                let position = item[0].getBoundingClientRect();

                input.css({
                    "top": position.top + item.height() / 2 - input.height() / 2,
                    "left": position.left,
                }).select();

                overlayDiv.on({
                    "click": () => updateValue(overlayDiv),
                    "keydown": (e) => {
                        e.keyCode === 13 && updateValue(overlayDiv);
                    },
                });
                $(window).scroll(() => {
                    // 待解决 滚动时执行了一次
                    updateValue(overlayDiv);
                    $(window).off("scroll");
                });
            }
        }

        #toggle() {
            let temp = this.#data.horz;
            this.#data.horz = this.#data.vert;
            this.#data.vert = temp;
            let tempSize = this.#data.horz_size;
            this.#data.horz_size = this.#data.vert_size;
            this.#data.vert_size = tempSize;
            this.#render(this.#data);
        }

        #updateData(hv) {
            let items = $(`div[ids="${hv === 'h' ? 'hItems' : 'vItems'}"]`).children();
            items.each((index, item) => {
                let text = $(item).text().trim();
                hv === "h" ?
                    this.#data.horz[index] = text && (this.#data.horz_size[index] = parseInt($(item).innerWidth())) :
                    this.#data.vert[index] = text && (this.#data.vert_size[index] = parseInt($(item).innerHeight()));
            });
        }

        #resize() {
            let config = {
                attributes: true,
                attributeFilter: ["style"],
                childList: false,
                characterData: false,
                subtree: false,
            };
            let observer = new MutationObserver((entrisy) => {
                entrisy.forEach((target) => {
                    target = target.target;
                    let hv = target.className.substr(5, 1);
                    let index = $(target).index();
                    hv === 'h' ?
                        this.#data.horz_size[index] = parseInt($(target).innerWidth()) :
                        this.#data.vert_size[index] = parseInt($(target).innerHeight());
                });
            });

            $(".panel .item")
                .each((index, item) => observer.observe(item, config));
        }

        add(hv, data) {
            if (hv === "h") {
                this.#data.horz.includes(data.title) ?
                    console.error("标题有重复") :
                    this.#data.horz.push(data.title) &&
                    this.#data.horz_size.push(data.size || 200) &&
                    this.#render(this.#data);
            } else if (hv === "v") {
                this.#data.vert.includes(data.title) ?
                    console.error("标题有重复") :
                    this.#data.vert.push(data.title) &&
                    this.#data.vert_size.push(data.size || 200) &&
                    this.#render(this.#data);
            } else {
                throw new Error("hv 参数错误");
            }
        }

        getData(hv) {
            return hv
                ? /^([hv])$/.test(hv)
                    ? hv === "h"
                        ? this.#data.horz
                        : this.#data.vert
                    : new Error("参数错误")
                : this.#data;
        }

        #drag(e, target, hv, box, name, name2, name3) {

            let range = {x: 0, y: 0};
            let lastPos = {x: 0, y: 0, x1: 0, y1: 0};
            let tarPos = {x: 0, y: 0, x1: 0, y1: 0};
            let thisDiv = null, move = false, choose = false;
            let thisDivWidth = 0, thisDivHeight = 0,
                thisDivHalfW = 0, thisDivHalfH = 0,
                tarFirstX = 0, tarFirstY = 0;
            let tarDiv = null, tarFirst, tempDiv;
            let initPos = {x: 0, y: 0};

            let flag = false;
            let stop = null;

            clearTimeout(stop);
            stop = setTimeout(() => {
                flag = true;
                let size = hv === "h" ?
                    $(e.target).parent().outerWidth() :
                    $(e.target).parent().outerHeight();
                choose = true;
                thisDiv = target;
                initPos.x = thisDiv.position().left;
                initPos.y = thisDiv.position().top;
                range.x = e.pageX - thisDiv.position().left;
                range.y = e.pageY - thisDiv.position().top;
                thisDivWidth = thisDiv.width();
                thisDivHeight = thisDiv.height();
                thisDivHalfW = thisDivWidth / 2;
                thisDivHalfH = thisDivHeight / 2;

                thisDiv.attr("class", name2);
                thisDiv.css({left: initPos.x + 'px', top: initPos.y + 'px'});
                tempDiv = $(`<div class="${name3}"></div>`);

                hv === "h" ?
                    (thisDiv.css({width: size}) && tempDiv.css({width: size}))
                    : (thisDiv.css({height: size}) && tempDiv.css({height: size}));

                tempDiv.insertBefore(thisDiv);

            }, 200);

            $(document)
                .on('mouseup', () => {
                    if (!flag) clearTimeout(stop);

                    if (!choose) return false;
                    if (!move) {
                        choose = false;
                        return false;
                    }
                    thisDiv.insertBefore(tempDiv);
                    thisDiv.css({left: "", top: ""});
                    thisDiv.addClass("item" + " " + name);
                    thisDiv.removeClass(name2);
                    tempDiv.remove();
                    move = false;
                    choose = false;
                    // 拖曳结束后，更新数据
                    this.#updateData(hv);
                })
                .on('mousemove', function (e) {
                    if (!choose) return false;
                    move = true;
                    lastPos.x = e.pageX - range.x;
                    lastPos.y = e.pageY - range.y;
                    lastPos.x1 = lastPos.x + thisDivWidth;
                    lastPos.y1 = lastPos.y + thisDivHeight;

                    hv === "h" ? thisDiv.css({"left": lastPos.x,}) : thisDiv.css({"top": lastPos.y});

                    let $main = $('.' + name);

                    $main.each(function () {
                        tarDiv = $(this);
                        tarPos.x = tarDiv.position().left;
                        tarPos.y = tarDiv.position().top;
                        tarPos.x1 = tarPos.x + tarDiv.width() / 2;
                        tarPos.y1 = tarPos.y + tarDiv.height() / 2;
                        tarFirst = $main.eq(0);
                        tarFirstX = tarFirst.position().left + thisDivHalfW / 2 + tarFirst.width() / 2;
                        tarFirstY = tarFirst.position().top + thisDivHalfH / 2 + tarFirst.height() / 2;

                        // 根据 拖拽对象x坐标 与 目标元素对象x坐标 对比，来显示 虚线div 在节点前、后出现的位置
                        if (lastPos.x > tarPos.x) {
                            //拖拽对象 移动到第一个位置
                            if (lastPos.x <= tarFirstX && lastPos.y <= tarFirstY)
                                tempDiv.insertBefore(tarFirst);
                            // 判断要插入目标元素的 坐标后， 直接插入
                            if (lastPos.x <= tarPos.x + thisDivHalfW && lastPos.x1 >= tarPos.x1 && lastPos.y <= tarPos.y + thisDivHalfH && lastPos.y1 >= tarPos.y1)
                                tempDiv.insertAfter(tarDiv);
                        } else {
                            //拖拽对象 移动到第一个位置
                            if (lastPos.x <= tarFirstX && lastPos.y <= tarFirstY)
                                tempDiv.insertBefore(tarFirst);
                            // 判断要插入目标元素的 坐标后， 直接插入
                            if (lastPos.x >= tarPos.x - thisDivHalfW && lastPos.x1 >= tarPos.x1 && lastPos.y >= tarPos.y - thisDivHalfH && lastPos.y1 >= tarPos.y1)
                                tempDiv.insertAfter(tarDiv);
                        }
                    });
                });


        }

    }

    let v = new Panel($('.panel'));


    v.add("h", {title: "第   aa一个", size: 400});
    v.add("h", {title: "第aa一个"});
    // v.add("h", {title: "第2个", size: 380});
    // v.add("h", {title: "第3个", size: 380});
    v.add("v", {title: "第2个1", size: 100});
    v.add("v", {title: "第2个", size: 380});

    // console.log(v.getData());

    // console.log(v.getData("h"));
    // console.log(v.getData("v"));
    // console.log(v.getData("a"));
</script>
</body>
</html>
