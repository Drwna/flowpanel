<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
          integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <title>float demo</title>
    <style>
        :root {
            --panel-size: 40px;
        }
        .panel > * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .panel {
            border: 1px solid rgb(80, 77, 77);
            /*padding: 8px;*/
            width: 1200px;
            height: 600px;
        }
        .panel .item-wrapper {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .panel .item > span {
            background-color: lightgoldenrodyellow;
            cursor: default;
        }
        .panel .icon-add, .panel .icon-delete {
            cursor: default;
        }

        .toggle {
            width: var(--panel-size);
            height: var(--panel-size);
            line-height: var(--panel-size);
            text-align: center;
            border-right: 1px solid black;
            border-bottom: 1px solid black;
            float: left;
            color: grey;
        }
        .toggle:hover {
            color: black;
        }

        .horz {
            background-color: red;
            width: calc(100% - var(--panel-size) - 1px);
            height: var(--panel-size);
            border-bottom: 1px solid black;
            display: flex;
            position: relative;
        }
        .horz > .icon-add {
            position: absolute;
            top: 50%; left: 0;
            transform: translateY(-50%);
            width: 21px;
            padding-left: 6px;
            display: none;
        }
        .horz:hover > .icon-add {
            display: block;
            color: grey;
        }
        .horz > .icon-add:hover {
            color: black;
            cursor: pointer;
        }
        .horz > .item-wrapper {
            height: 100%;
            display: flex;
        }
        .horz .item {
            width: 200px;
            height: 100%;
            position: relative;
            display: flex;
            border-right: 1px solid black;
        }
        .horz .item span {
            width: 100%; height: 100%;
            padding: 0 27px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
            line-height: var(--panel-size);
        }
        .horz:hover .item {
            overflow: hidden;
            resize: horizontal;
        }
        .horz .icon-delete {
            position: absolute;
            top: 50%; right: 0;
            transform: translateY(-50%);
            width: 21px;
            height: var(--panel-size);
            line-height: var(--panel-size);
            padding-right: 6px;
            display: none;
            color: grey;
        }

        .horz .item:hover .icon-delete {
            display: block;
        }
        .horz .item:hover .icon-delete:hover {
            color: black;
            cursor: pointer;
        }

        .vert {
            /*TODO: height:100% */
            background-color: red;
            height: calc(100% - var(--panel-size) - 1px);
            width: var(--panel-size);
            border-right: 1px solid black;
            display: flex;
            position: relative;
        }
        .vert > .icon-add {
            position: absolute;
            top: 0; left: 50%;
            transform: translateX(-50%);
            height: 21px;
            padding-top: 6px;
            color: grey;
            display: none;
        }
        .vert:hover > .icon-add {
            display: block;
        }
        .vert > .icon-add:hover {
            color: black;
            cursor: pointer;
        }
        .vert > .item-wrapper {
            width: 100%;
        }
        .vert .item {
            width: 100%;
            height: 140px;
            -webkit-writing-mode: vertical-rl;
            writing-mode: vertical-lr;
            display: flex;
            text-align: center;
            position: relative;
            border-bottom: 1px solid black;
        }
        .vert:hover .item {
            overflow: hidden;
            resize: vertical;
        }
        .vert .item span {
            height: 100%; width: 100%;
            padding: 27px 0;
            line-height: var(--panel-size);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .vert .icon-delete {
            position: absolute;
            bottom: 0; left: 50%;
            transform: translateX(-50%);
            height: 21px;
            padding-bottom: 6px;
            display: none;
            width: var(--panel-size);
            line-height: var(--panel-size);
        }
        .vert .item:hover .icon-delete {
            display: block;
            color: grey;
        }
        .vert .item:hover .icon-delete:hover {
            color: black;
            cursor: pointer;
        }

        .horz input {
            text-align: center;
            height: 80%; width: 90%;
            font-size: inherit;
            outline-style: none;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
        }
        .horz input:focus {
            border-color: #66afe9;
            outline: 0;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075),
            0 0 8px rgba(102, 175, 233, 0.6);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
            z-index: 9999;
        }
        .overlay input {
            position: fixed;
            width: 200px;
            height: 34px;
            text-align: center;
            font-size: inherit;
            outline-style: none;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
        }
        .overlay input:focus {
            border-color: #66afe9;
            outline: 0;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075),
            0 0 8px rgba(102, 175, 233, 0.6);
        }

        .hDragItem {
            position: absolute;
            height: 100%;
            line-height: var(--panel-size);
            text-align: center;
            background-color: grey;
            color: white;
            border-radius: 5px;
            box-shadow: 0 0 5px #ccc;
            z-index: 4;
        }
        .hDragItem span {
            padding: 0 20px;
        }

        .hPlaceholder {
            outline: 1px dashed black;
            height: 100%;
            background-color: lightblue;
        }

        .vDragItem {
            position: absolute;
            width: 100%;
            line-height: var(--panel-size);
            text-align: center;
            white-space: nowrap;
            background-color: grey;
            color: white;
            border-radius: 5px;
            box-shadow: 0 0 5px #ccc;
            z-index: 4;
            -webkit-writing-mode: vertical-rl;
            writing-mode: vertical-lr;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .vDragItem span {
            padding: 20px 0;
        }
        .vPlaceholder {
            outline: 1px dashed black;
            background-color: lightblue;
        }
        .vResizeable {
            overflow: hidden;
            resize: vertical;
        }
        .hResizeable {
            overflow: hidden;
            resize: horizontal;
        }

        /*拖曳调试代码*/
        body {
            margin-top: 80px;
        }
    </style>
</head>
<body>
<div class="panel"></div>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="jstx/src/jst-core.js"></script>
<script>

    class Panel {

        #data = {
            horz: [],
            vert: [],
            horz_size: [],
            vert_size: [],
        };

        #template = $(`
            <div class="panel-wrapper">
                <i class="toggle fa fa-refresh fa-lg"></i>
                <div class="horz">
                    <div ids="hItems" class="item-wrapper">
                        <div jst-for="let i=0; i<horz.length; i++" class="item hItem"
                             style="width: {{horz_size[i]}}px;">
                            <span jst-text="{{horz[i]}}"></span>
                            <i class="icon-delete fa fa-minus-circle fa-lg"></i>
                        </div>
                    </div>
                    <i class="icon-add fa fa-plus-circle fa-lg"></i>
                </div>
                <div class="vert">
                    <div ids="vItems" class="item-wrapper">
                        <div jst-for="let i=0; i<vert.length; i++" class="item vItem"
                             style="height: {{vert_size[i]}}px;">
                            <span jst-text="{{vert[i]}}"></span>
                            <i class="icon-delete fa fa-minus-circle fa-lg"></i>
                        </div>
                    </div>
                    <i class="icon-add fa fa-plus-circle fa-lg"></i>
                </div>
            </div>
        `);

        constructor(root) {
            this.root = root;
            this.#init(root, this.#template, this.#data);
        }

        #init(root, template, data) {
            template.appendTo(root);
            this.#render(data);
            this.#bindEvent();
        }

        #render(data) {
            new jst($(".panel-wrapper")[0]).render(data);
        }

        #bindEvent() {
            this.root.on("dblclick", ".toggle", () => this.#toggle());
            this.root.on("dblclick", "span", (e) => this.#edit($(e.target)));
            this.root.on("click", ".icon-delete", (e) => this.#removeField($(e.target)));
            this.root.on("click", ".icon-add", (e) => this.#addDefaultField($(e.target)));
            this.root.on("mousedown", ".item", (e) => {
                // resize
                if ($(e.target).hasClass("item")
                    && window.getComputedStyle(e.target).cursor === "auto") {
                    this.#resize(e.target);
                    return;
                }

                let mousePosX = e.pageX, mousePosY = e.pageY;
                let isDragging = false;
                let distanceX, distanceY;

                this.root.on("mousemove", (event) => {
                    // 判断是否在指定元素上移动
                    if (event.target.tagName.toLowerCase() !== "span") {
                        this.root.off("mousemove mouseup");
                        return false;
                    }
                    distanceX = Math.abs(event.pageX - mousePosX);
                    distanceY = Math.abs(event.pageY - mousePosY);
                    // 判断鼠标是否移动一定距离，如果移动则开始拖曳
                    if (distanceX > 10 || distanceY > 10) {
                        isDragging = true;
                        let hv = $(e.target).parents(".item-wrapper").parents().attr("class").substr(0, 1);
                        this.#drag(e, hv, `${hv}Item`, `${hv}DragItem`, `${hv}Placeholder`);
                        this.root.off("mousemove");
                    }
                    this.root.on("mouseup", () => {
                        isDragging = false;
                        this.root.off("mousemove");
                    });
                });
            });
        }

        #addDefaultField(target) {
            let hv = target.parent().attr("class").substr(0, 1);
            let title = "新增字段";
            let {horz, vert, horz_size: hs, vert_size: vs} = this.#data;
            hv === "h" ?
                horz.push(title) && hs.push(200)
                : vert.push(title) && vs.push(200);
            this.#render(this.#data);
        }

        #removeField(target) {
            let hv = target.parents(".item-wrapper").parent().attr("class").substr(0, 1);
            let index = target.parent().index();
            let {horz, vert, horz_size: hs, vert_size: vs} = this.#data;
            hv === "h" ?
                horz.splice(index, 1) && hs.splice(index, 1)
                : vert.splice(index, 1) && vs.splice(index, 1);
            target.parent().remove();
        }

        #edit(target) {
            let hv = target.parents(".item-wrapper").parent().attr("class").substr(0, 1);
            let oldText = target[0].innerText;
            let newText;
            let input = $(`<input type='text'/>`).val(oldText);

            let updateValue = (o) => {
                newText = input.val().trim() === "" ? oldText : input.val().trim();
                target.html(newText);
                o?.remove();
                $(window).off("mousewheel");
                if (newText === oldText) return;
                let index = target.parent().index();
                hv === "h" ?
                    this.#data.horz[index] = newText :
                    this.#data.vert[index] = newText;
            };

            let eventListener = (param, pos) => {
                pos && input.css(pos);
                $(window).on("mousewheel", () => updateValue(param));
                input.select().on({
                    "blur": () => updateValue(param),
                    "keydown": (e) => {
                        e.keyCode === 13 && updateValue(param);
                    }
                });
            };

            if (hv === "h") {
                target.html(input);
                eventListener();
            } else {
                let overlayDiv = $(`<div class="overlay"></div>`);
                overlayDiv.append(input).appendTo($(document.body));
                let item = target.parent();
                let {left, top} = item.offset();
                top = top + item.height() / 2 - input.height() / 2;
                eventListener(overlayDiv, {top, left});
            }
        }

        #toggle() {
            let {horz, vert, horz_size, vert_size} = this.#data;
            [horz, vert, horz_size, vert_size] = [vert, horz, vert_size, horz_size];
            this.#data = {horz, vert, horz_size, vert_size};
            this.#render(this.#data);
        }

        #updateData(hv) {
            let {horz, vert, horz_size: hs, vert_size: vs} = this.#data;
            let items = $(`.${hv === "h" ? "horz" : "vert"} .item`);
            items.each((index, item) => {
                item = $(item);
                let text = item.text().trim();
                hv === "h" ?
                    (horz[index] = text) && (hs[index] = parseInt(item.innerWidth())) :
                    (vert[index] = text) && (vs[index] = parseInt(item.innerHeight()));
            });
        }

        #resize(target) {
            let hv = $(target).parents(".item-wrapper").parent().attr("class").substr(0, 1);
            let active = hv === "h" ? "hResizeable" : "vResizeable";
            $(target).addClass(active);
            $(document).on("mouseup", () => $(target).removeClass(active));
            let config = {
                attributes: true,
                attributeFilter: ["style"],
                childList: false,
                characterData: false,
                subtree: false,
            };
            let observer = new MutationObserver(entrisy => {
                entrisy.forEach(mutation => {
                    target = $(mutation.target);
                    let index = target.index();
                    if (hv === "h") {
                        target.innerWidth() <= 140 && target.css({width: "140px"});
                        this.#data.horz_size[index] = parseInt(target.innerWidth());
                    } else {
                        target.innerHeight() <= 140 && target.css({height: "140px"});
                        this.#data.vert_size[index] = parseInt(target.innerHeight());
                    }
                });
            });
            observer.observe(target, config);
        }

        #drag(e, hv, item, dragItem, placeholder) {
            let range = {x: 0, y: 0};
            let lastPos = {x: 0, y: 0, x1: 0, y1: 0};
            let tarPos = {x: 0, y: 0, x1: 0, y1: 0};
            let move = false, choose = false;
            let thisDivWidth = 0, thisDivHeight = 0,
                thisDivHalfW = 0, thisDivHalfH = 0,
                tarFirstX = 0, tarFirstY = 0;
            let tarDiv = null, tarFirst, tempDiv;
            let initPos = {x: 0, y: 0};
            let target = $(e.target).parent();
            let size = hv === "h" ? target.outerWidth() : target.outerHeight();

            choose = true;
            initPos.x = target.position().left;
            initPos.y = target.position().top;
            range.x = e.pageX - target.position().left;
            range.y = e.pageY - target.position().top;
            thisDivWidth = target.width();
            thisDivHeight = target.height();
            thisDivHalfW = thisDivWidth / 2;
            thisDivHalfH = thisDivHeight / 2;

            target.attr("class", dragItem)
                .css({left: initPos.x + 'px', top: initPos.y + 'px'});
            tempDiv = $(`<div class="${placeholder}"></div>`);
            hv === "h" ?
                (target.css({width: size}) && tempDiv.css({width: size}))
                : (target.css({height: size}) && tempDiv.css({height: size}));
            tempDiv.insertBefore(target);

            $(document)
                .on('mouseup', () => {
                    if (!choose) return false;
                    target.insertBefore(tempDiv)
                        .css({left: "", top: ""})
                        .attr("class", "item" + " " + item);
                    tempDiv.remove();
                    if (!move) {
                        choose = false;
                        return false;
                    }
                    this.#updateData(hv);
                    move = false;
                    choose = false;
                })
                .on('mousemove', function (e) {
                    if (!choose) return false;
                    move = true;
                    lastPos.x = e.pageX - range.x;
                    lastPos.y = e.pageY - range.y;
                    lastPos.x1 = lastPos.x + thisDivWidth;
                    lastPos.y1 = lastPos.y + thisDivHeight;

                    hv === "h" ? target.css({"left": lastPos.x,}) : target.css({"top": lastPos.y});

                    let $main = $(`.${item}`);

                    $main.each(function () {
                        tarDiv = $(this);
                        tarPos.x = tarDiv.position().left;
                        tarPos.y = tarDiv.position().top;
                        tarPos.x1 = tarPos.x + tarDiv.width() / 2;
                        tarPos.y1 = tarPos.y + tarDiv.height() / 2;
                        tarFirst = $main.eq(0);
                        tarFirstX = tarFirst.position().left + thisDivHalfW / 2;
                        tarFirstY = tarFirst.position().top + thisDivHalfH / 2;

                        // 根据 拖拽对象x坐标 与 目标元素对象x坐标 对比，来显示 虚线div 在节点前、后出现的位置
                        if (lastPos.x > tarPos.x) {
                            //拖拽对象 移动到第一个位置
                            if (lastPos.x <= tarFirstX && lastPos.y <= tarFirstY)
                                tempDiv.insertBefore(tarFirst);
                            // 判断要插入目标元素的 坐标后， 直接插入
                            if (lastPos.x <= tarPos.x + thisDivHalfW && lastPos.x1 >= tarPos.x1 && lastPos.y <= tarPos.y + thisDivHalfH && lastPos.y1 >= tarPos.y1)
                                tempDiv.insertAfter(tarDiv);
                        } else {
                            //拖拽对象 移动到第一个位置
                            if (lastPos.x <= tarFirstX && lastPos.y <= tarFirstY)
                                tempDiv.insertBefore(tarFirst);
                            // 判断要插入目标元素的 坐标后， 直接插入
                            if (lastPos.x >= tarPos.x - thisDivHalfW && lastPos.x1 >= tarPos.x1 && lastPos.y >= tarPos.y - thisDivHalfH && lastPos.y1 >= tarPos.y1)
                                tempDiv.insertAfter(tarDiv);
                        }
                    });
                });

        }

        add(hv, data) {
            if (!hv) throw new Error("hv is required");
            if (hv !== "h" && hv !== "v") throw new Error("hv must be h or v");
            if (!data || !data.title || /^[ ]*$/.test(data.title)) throw new Error("title is required");
            let {horz, vert, horz_size: hs, vert_size: vs} = this.#data;
            let {title, size} = data;
            hv === "h" ?
                horz.includes(title) ? console.error("title is exist") :
                    horz.push(title) && hs.push(size <= 140 ? 140 : size)
                :
                vert.includes(title) ? console.error("title is exist") :
                    vert.push(title) && vs.push(size <= 140 ? 140 : size);
            this.#render(this.#data);
        }

        getData(hv) {
            return hv
                ? /^([hv])$/.test(hv)
                    ? hv === "h"
                        ? this.#data.horz
                        : this.#data.vert
                    : hv === "all" ? this.#data : new Error("parameter must be h or v or all")
                : {horz: this.#data.horz, vert: this.#data.vert};
        }

    }

    let JFlow = {
        panel: (selector) => new Panel(selector)
    };

    let j = JFlow.panel($('.panel'));

    j.add("h", {title: "人事部", size: 300});
    // j.add("v", {title: " "});
    j.add("h", {title: "行政部"});
    j.add("h", {title: "开发部", size: 380});
    // 最小尺寸为:140
    j.add("v", {title: "起草", size: 300});
    j.add("v", {title: "处理", size: 80});
    //
    console.log(j.getData("xxx"));
    console.log(j.getData());
    // console.log(j.getData("h"));
    // console.log(j.getData("v"));
    // console.log(j.getData("all"));

</script>
</body>
</html>
