<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8"/>
    <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover"/>
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
          integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw=="
          crossorigin="anonymous" referrerpolicy="no-referrer"/>
    <title>float demo</title>
    <style>
        :root {
            --panel-size: 40px;
        }
        .panel > * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        .panel {
            border: 1px solid rgb(80, 77, 77);
            /*padding: 8px;*/
            width: 1000px;
            height: 600px;
        }
        .panel .item-wrapper {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        .panel .item > span {
            background-color: yellowgreen;
            cursor: default;
        }
        .panel .icon-add, .panel .icon-delete {
            cursor: default;
        }

        .toggle {
            width: var(--panel-size);
            height: var(--panel-size);
            line-height: var(--panel-size);
            text-align: center;
            border: 1px solid black;
            float: left;
            color: grey;
        }
        .toggle:hover {
            color: black;
        }

        .horz {
            width: 600px;
            height: var(--panel-size);
            border-top: 1px solid black;
            border-right: 1px solid black;
            border-bottom: 1px solid black;
            display: flex;
            position: relative;
        }
        .horz > .icon-add {
            position: absolute;
            top: 50%; left: 0;
            transform: translateY(-50%);
            width: 21px;
            padding-left: 6px;
            display: none;
        }
        .horz:hover > .icon-add {
            display: block;
            color: grey;
        }
        .horz > .icon-add:hover {
            color: black;
            cursor: pointer;
        }
        .horz > .item-wrapper {
            height: 100%;
            display: flex;
        }
        .horz .item {
            /* 待 js 设置 width */
            width: 200px;
            height: 100%;
            position: relative;
            display: flex;
            border-right: 1px solid black;
            background-color: wheat;
        }
        .horz .item span {
            width: 100%; height: 100%;
            padding: 0 27px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            text-align: center;
            line-height: var(--panel-size);
        }
        .horz .item:hover {
            overflow: hidden;
            resize: horizontal;
        }
        .horz .icon-delete {
            position: absolute;
            top: 50%; right: 0;
            transform: translateY(-50%);
            width: 21px;
            height: var(--panel-size);
            line-height: var(--panel-size);
            padding-right: 6px;
            display: none;
        }

        .horz .item:hover .icon-delete {
            display: block;
            color: grey;
        }
        .horz .item:hover .icon-delete:hover {
            color: black;
            cursor: pointer;
        }

        .vert {
            height: 500px;
            width: var(--panel-size);
            border-left: 1px solid black;
            border-right: 1px solid black;
            border-bottom: 1px solid black;
            display: flex;
            position: relative;
        }
        .vert > .icon-add {
            position: absolute;
            top: 0; left: 50%;
            transform: translateX(-50%);
            height: 21px;
            padding-top: 6px;
            display: none;
        }
        .vert:hover > .icon-add {
            display: block;
            color: grey;
        }
        .vert > .icon-add:hover {
            color: black;
            cursor: pointer;
        }
        .vert > .item-wrapper {
            width: 100%;
        }
        .vert .item {
            width: 100%;
            height: 140px;
            -webkit-writing-mode: vertical-rl;
            writing-mode: vertical-lr;
            /* 垂直方向自右而左的书写方式。即top-bottom-right-left */
            display: flex;
            text-align: center;
            position: relative;
            border-bottom: 1px solid black;
        }
        .vert .item:hover {
            overflow: hidden;
            resize: vertical;
        }
        .vert .item span {
            height: 100%; width: 100%;
            padding: 27px 0;
            line-height: var(--panel-size);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .vert .icon-delete {
            position: absolute;
            bottom: 0; left: 50%;
            transform: translateX(-50%);
            height: 21px;
            padding-bottom: 6px;
            display: none;
            width: var(--panel-size);
            line-height: var(--panel-size);
        }
        .vert .item:hover .icon-delete {
            display: block;
            color: grey;
        }
        .vert .item:hover .icon-delete:hover {
            color: black;
            cursor: pointer;
        }

        .horz input {
            text-align: center;
            height: 80%; width: 90%;
            font-size: inherit;
            outline-style: none;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
        }
        .horz input:focus {
            border-color: #66afe9;
            outline: 0;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075),
            0 0 8px rgba(102, 175, 233, 0.6);
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /*background-color: rgba(0, 0, 0, 0.5);*/
            background-color: transparent;
            z-index: 9999;
        }
        .overlay input {
            position: fixed;
            width: 200px;
            height: 34px;
            text-align: center;
            font-size: inherit;
            outline-style: none;
            border: 1px solid #ccc;
            border-radius: 3px;
            background: #fff;
        }
        .overlay input:focus {
            border-color: #66afe9;
            outline: 0;
            box-shadow: inset 0 1px 1px rgba(0, 0, 0, .075),
            0 0 8px rgba(102, 175, 233, 0.6);
        }
    </style>
</head>
<body>
<div class="panel"></div>
<script src="https://cdn.bootcdn.net/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
<script src="jstx/src/jst-core.js"></script>
<script>

    class Panel {

        #data = {
            horz: ["人事部1", "开开发部开发部开发部发部", "人事部2", "人事部3",],
            vert: ["起起草起草起草起草草", "审批", "处理"],
        };

        #template = $(`
            <div class="panel-wrapper">
                <i class="toggle fa fa-refresh fa-lg"></i>
                <div class="horz">
                    <div ids="xItems" class="item-wrapper">
                        <div draggable="true" jst-for="let i=0; i<horz.length; i++" class="item xItem" >
                            <span jst-text="{{horz[i]}}"></span>
                            <i class="icon-delete fa fa-minus-circle fa-lg"></i>
                        </div>
                    </div>
                    <i class="icon-add fa fa-plus-circle fa-lg"></i>
                </div>
                <div class="vert">
                    <div ids="yItems" class="item-wrapper">
                        <div jst-for="let i=0; i<vert.length; i++" class="item">
                            <span jst-text="{{vert[i]}}"></span>
                            <i class="icon-delete fa fa-minus-circle fa-lg"></i>
                        </div>
                    </div>
                    <i class="icon-add fa fa-plus-circle fa-lg"></i>
                </div>
            </div>
        `);

        constructor(root) {
            this.root = root;
            this.init(root, this.#template, this.#data);
            this.bindEvent();
            this.end();
        }

        init(root, template, data) {
            template.appendTo(root);
            this.render(data);
        }

        render(data) {
            new jst($(".panel-wrapper")[0]).render(data);
        }

        bindEvent() {
            this.root.on({
                "click": (e) => {
                    e.stopPropagation();
                    let target = $(e.target);
                    let targetName = e.target.className.toLowerCase();
                    let hv;
                    // 添加默认字段
                    if (targetName.includes("icon-add")) {
                        hv = target.parent().attr("class").substr(0, 1);
                        this.addDefaultField(hv);
                    } else if (targetName.includes('icon-delete')) {
                        hv = target.parents(".item-wrapper").parent().attr("class").substr(0, 1);
                        this.removeField(hv, target);
                    }
                },
                "dblclick": (e) => {
                    e.stopPropagation();
                    if (e.target.className.toLowerCase().includes("toggle")) {
                        // 双击切换
                        this.toggle();
                    } else if (e.target.nodeName.toLowerCase().includes("span")) {
                        // 双击编辑
                        // this.edit($(e.target));
                    }
                },
                // "mousedown": (e) => {
                // let target = e.target;
                // let cursorStyle = window.getComputedStyle(target).cursor;
                // let tagName = target.tagName.toLowerCase();
                //
                // if (cursorStyle !== "auto" && cursorStyle !== "pointer" && tagName === "span") {
                //     console.log("执行拖曳");
                //     this.dragSort();
                // }
                // },
            });
        }

        addDefaultField(hv) {
            let title = "新增字段";
            hv === "h" ? this.#data.horz.push(title) : this.#data.vert.push(title);
            this.render(this.#data);
        }

        removeField(hv, target) {
            let index = target.parent().index();
            hv === "h" ? this.#data.horz.splice(index, 1) : this.#data.vert.splice(index, 1);
            this.render(this.#data);
        }

        edit(target) {
            // 还可优化
            let currentTag = target;
            let hv = currentTag.parents(".item-wrapper")
                .parent()[0].className.substr(0, 1);
            let oldText = target[0].innerText;
            let newText;
            let input = $(`<input type='text' value=${oldText} />`);

            let updateValue = (o) => {
                newText = input.val().trim() === "" ? oldText : input.val().trim();
                currentTag.html(newText);
                o?.remove();
                if (newText === oldText) return;
                let index = target.parent().index();
                hv === "h" ?
                    this.#data.horz[index] = newText :
                    this.#data.vert[index] = newText;
                this.render(this.#data);
                console.log(this.#data);
            };

            if (hv === 'h') {
                currentTag.html(input);
                input.select().on({
                    "blur": () => updateValue(),
                    "keydown": (e) => {
                        e.keyCode === 13 && updateValue();
                    },
                });
                $(window).scroll(() => {
                    updateValue();
                    $(window).off("scroll");
                });
            } else {
                let overlayDiv = $(`<div class="overlay"></div>`);

                input.appendTo(overlayDiv);
                overlayDiv.appendTo($(document.body));

                let item = currentTag.parent();
                let position = item[0].getBoundingClientRect();

                input.css({
                    "top": position.top + item.height() / 2 - input.height() / 2,
                    "left": position.left,
                }).select();

                overlayDiv.on({
                    "click": () => updateValue(overlayDiv),
                    "keydown": (e) => {
                        e.keyCode === 13 && updateValue(overlayDiv);
                    },
                });
                $(window).scroll(() => {
                    // 待解决 滚动时执行了一次
                    updateValue(overlayDiv);
                    $(window).off("scroll");
                });
            }
        }

        toggle() {
            console.log("函数 toggle");
            console.log("交换前： ", this.#data.horz, this.#data.vert);
            let temp = this.#data.horz;
            this.#data.horz = this.#data.vert;
            this.#data.vert = temp;
            console.log("交换后： ", this.#data.horz, this.#data.vert);
            this.render(this.#data);
            // 交换尺寸
            // TODO: 待优化
        }

        add(hv, data) {
            console.log("函数 add");
            let {title, size} = data;
            hv === "h" ?
                this.#data.horz.push(title) :
                this.#data.vert.push(title);
            console.log("添加后： ", this.#data);
            this.render(this.#data);

            // TODO: 添加数据 待优化
            if (size) {
                setTimeout(() => {
                    let wrapper = $("div[ids=xItems]");
                    console.log("wrapper: ", wrapper);
                    for (let i = 0; i < wrapper.children().length; i++) {
                        let item = wrapper.children().eq(i).children();
                        if (title === item.text())
                            item.parent().css({width: size,});
                    }
                }, 0);
            }
        }

        getData(hv) {
            return hv
                ? /^([hv])$/.test(hv)
                    ? hv === "h"
                        ? this.#data.horz
                        : this.#data.vert
                    : new Error("参数错误")
                : this.#data;
        }


        end() {
            setTimeout(() => {
                // this.dragSort("h");
                this.drag2();
            }, 1000);
        }

        dragSort(hv) {
            let range = {x: 0, y: 0};
            let lastPosition = {x: 0, y: 0, x1: 0, y1: 0};
            let targetPosition = {x: 0, y: 0, x1: 0, y1: 0};
            let thisDiv = null, move = null, choose = null;

            // 拖曳对象的索引、高度、宽度的初始化
            let thisDivWidth = 0, thisDivHeight = 0,
                thisDivHalfWidth = 0, thisDivHalfHeight = 0,
                targetFirstX = 0, targetFirstY = 0;

            // 要插入的目标元素的对象，临时虚线框的对象
            let targetDiv = null, targetFirst = null, tempDiv = null;

            // 记录鼠标按下时的位置
            let initPosition = {x: 0, y: 0};


            console.log("要拖曳的元素包裹器", $("div[ids=xItems]"));
            $("div[ids=xItems]").on("mousedown", ".item", function (e) {

                let target = e.target;
                let cursorStyle = window.getComputedStyle(target).cursor;
                if (cursorStyle !== "default") {
                    return;
                }

                choose = true;

                thisDiv = $(this);

                // 记录拖曳元素初始位置
                initPosition.x = thisDiv.position().left;
                initPosition.y = thisDiv.position().top;
                console.log("initPosition: ", initPosition.x, initPosition.y);


                // 鼠标元素相对偏移量
                range.x = e.pageX - thisDiv.position().left;
                range.y = e.pageY - thisDiv.position().top;
                // console.log("鼠标相对偏移量： ", range.x, range.y);

                thisDivWidth = thisDiv.width();
                thisDivHeight = thisDiv.height();
                // console.log("拖曳元素的宽高度： ", thisDivWidth, thisDivHeight);

                thisDivHalfWidth = thisDivWidth / 2;
                thisDivHalfHeight = thisDivHeight / 2;
                // console.log("拖曳元素的一半宽高度： ", thisDivHalfWidth, thisDivHalfHeight);

                // console.log("thisDiv: ", thisDiv);
                console.log("===========================");

                // 拖曳的样式
                thisDiv.css({
                    bgColor: "grey",
                    color: "white",
                    zIndex: "999",
                    position: "absolute",
                    left: initPosition.x,
                    top: initPosition.y,
                    width: thisDivWidth,
                    height: thisDivHeight,
                    borderRadius: "5px",
                    borderShadow: "0 0 5px #ccc",
                });
                hv === "h" ? thisDiv.css({
                    border: "1px solid black",
                    borderTop: "none",
                    borderBottom: "none",
                }) : thisDiv.css({
                    border: "1px solid black",
                    borderLeft: "none",
                    borderRight: "none",
                });


                // 插入虚线框
                tempDiv = $("<div></div>");
                tempDiv.css({
                    // position: "absolute",
                    // left: initPosition.x,
                    // top: initPosition.y,
                    width: thisDivWidth - 1,
                    height: thisDivHeight,
                    border: "1px dashed black",
                    zIndex: "999",
                });
                tempDiv.insertBefore(thisDiv);
            });

            $(document)
                .on("mouseup", function () {

                    if (!choose) {
                        return;
                    }

                    if (!move) {
                        thisDiv.css({
                            bgColor: "white",
                            color: "black",
                            zIndex: "",
                            position: "relative",
                            left: "",
                            top: "",
                            borderRadius: "",
                            borderShadow: "none",
                        });
                        tempDiv.remove();
                        choose = false;
                        return;
                    }

                    thisDiv.insertBefore(tempDiv);
                    tempDiv.remove();
                    thisDiv.css({
                        bgColor: "",
                        color: "",
                        zIndex: "",
                        position: "",
                        left: "",
                        top: "",
                        width: "",
                        height: "",
                        borderRadius: "",
                    });
                    choose = false;
                    move = false;
                })
                .on("mousemove", function (e) {


                    if (!choose) return false;

                    move = true;
                    lastPosition.x = e.pageX - range.x;
                    lastPosition.y = e.pageY - range.y;
                    lastPosition.x1 = lastPosition.x + thisDivWidth;
                    lastPosition.y1 = lastPosition.y + thisDivHeight;

                    // 拖曳元素随鼠标移动
                    thisDiv.css({
                        "left": hv === "h" ? lastPosition.x : "",
                        "top": hv === "v" ? lastPosition.y : "",
                    });

                    // 按照重新排列过的顺序，再次获取各个元素的位置
                    let $main = $("div[ids=xItems]").children(".item");

                    $main.each(function () {
                        let targetDiv = $(this);

                        targetPosition.x = targetDiv.position().left;
                        targetPosition.y = targetDiv.position().top;
                        targetPosition.x1 = targetPosition.x + targetDiv.width() / 2;
                        targetPosition.y1 = targetPosition.y + targetDiv.height() / 2;
                        targetFirst = $main.eq(0);
                        targetFirstX = targetFirst.position().left + thisDivHalfWidth / 2;
                        targetFirstY = targetFirst.position().top + thisDivHalfHeight / 2;

                        // 根据拖曳对象坐标与目标元素对象坐标对比，来显示虚线框在节点前或后的位置
                        if (lastPosition.x > targetPosition.x) {
                            // 拖曳对象 移动到第一个位置
                            if (lastPosition.x <= targetFirstX && lastPosition.y <= targetFirstY) {
                                tempDiv.insertBefore(targetFirst);
                            }
                            // 判断要插入目标元素的位置，直接插入
                            if (lastPosition.x <= targetPosition.x + thisDivHalfWidth && lastPosition.x1 >= targetPosition.x1 && lastPosition.y <= targetPosition.y + thisDivHalfHeight && lastPosition.y1 >= targetPosition.y1) {
                                tempDiv.insertBefore(targetDiv);
                            }
                        } else {
                            // 拖曳对象，移动到第一个位置
                            if (lastPosition.x <= targetFirstX && lastPosition.y <= targetFirstY) {
                                tempDiv.insertBefore(targetFirst);
                            }
                            // 判断要插入目标元素的位置，直接插入
                            if (lastPosition.x1 >= targetPosition.x - thisDivHalfWidth && lastPosition.x1 >= targetPosition.x1 && lastPosition.y >= targetPosition.y - thisDivHalfHeight && lastPosition.y1 >= targetPosition.y1) {
                                tempDiv.insertAfter(targetDiv);
                            }
                        }


                    });

                });

        }

        drag2() {
            let node = document.querySelector(".item-wrapper");
            let draging = null;
            // 使用事件委托，将li事件绑定到ul上
            node.ondragstart = function (e) {
                e.dataTransfer.setData("text/plain", e.target.innerText);
                draging = e.target;
            };
            node.ondragover = function (e) {
                e.preventDefault();
                let target = e.target;
                // 判断是否是li元素
                if (target.nodeName.toLowerCase() === "div" && target !== draging) {
                    // _index是实现的获取index
                    if (_index(draging) < _index(target)) {
                        target.parentNode.insertBefore(draging, target.nextSibling);
                    } else {
                        target.parentNode.insertBefore(draging, target);
                    }
                }

                function _index(el) {
                    let index = 0;
                    if (!el || !el.parentNode) {
                        return -1;
                    }
                    while (el && (el = el.previousElementSibling)) {
                        index++;
                    }
                    return index;
                }
            };

        }
    }

    let v = new Panel($('.panel'));


    // v.add("h", {title: "第   aa一个",});
    // v.add("h", {title: "第2个", size: 380});
    // v.add("v", {title: "第2个", size: 380});

    // console.log(v.getData());
    // console.log(v.getData("h"));
    // console.log(v.getData("v"));
    // console.log(v.getData("a"));

</script>
</body>
</html>
